package com.hackathon2_BE.pium.service;

import com.hackathon2_BE.pium.dto.UploadProductImageResponse;
import com.hackathon2_BE.pium.dto.CreateProductRequest;
import com.hackathon2_BE.pium.dto.ProductOptionResponse;
import com.hackathon2_BE.pium.dto.SellerProductListResponse;
import com.hackathon2_BE.pium.entity.ProductImage;
import com.hackathon2_BE.pium.entity.Category;
import com.hackathon2_BE.pium.entity.Product;
import com.hackathon2_BE.pium.entity.User;
import com.hackathon2_BE.pium.exception.InvalidInputException;
import com.hackathon2_BE.pium.exception.ResourceNotFoundException;
import com.hackathon2_BE.pium.exception.ForbiddenException;
import com.hackathon2_BE.pium.exception.UnauthenticatedException;
import com.hackathon2_BE.pium.repository.ProductImageRepository;
import com.hackathon2_BE.pium.repository.CategoryRepository;
import com.hackathon2_BE.pium.repository.ProductRepository;
import com.hackathon2_BE.pium.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.time.LocalDateTime;
import java.util.*;
import java.io.IOException;
import java.nio.file.*;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class ProductService {

    private final ProductRepository productRepository;
    private final CategoryRepository categoryRepository;
    private final UserRepository userRepository;
    private final ProductImageRepository productImageRepository;
    private final FastApiClient fastApiClient;

    @Value("${app.upload.dir:uploads}")
    private String uploadRootDir;

    private static final Set<String> ALLOWED_EXT = Set.of("jpg", "jpeg", "png", "webp");

    // 2-1) ÏÉÅÌíà Î™©Î°ù/Í≤ÄÏÉâ/ÌïÑÌÑ∞
    public Page<Product> getProductList(String keyword, Long categoryId, Pageable pageable){
        if (keyword != null && !keyword.isBlank()){
            return productRepository.findByNameContainingIgnoreCaseOrInfoContainingIgnoreCase(keyword, keyword, pageable);
        } else if (categoryId != null){
            return productRepository.findByCategory_Id(categoryId, pageable);
        } else {
            return productRepository.findAll(pageable);
        }
    }

    // 2-2) ÏÉÅÌíà ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï°∞Ìöå
    public Product getProductById(Long id){
        return productRepository.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("Ìï¥Îãπ ÏÉÅÌíàÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."));
    }

    // 3-1) ÏÉÅÌíà Íµ¨Îß§ ÏòµÏÖò Ï°∞Ìöå
    public ProductOptionResponse getProductOptions(Long productId) {
        Product p = productRepository.findById(productId)
                .orElseThrow(() -> new ResourceNotFoundException("Ìï¥Îãπ ÏÉÅÌíàÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."));

        String unitLabel = (p.getUnitLabel() == null || p.getUnitLabel().isBlank()) ? "Í∞ú" : p.getUnitLabel();
        int stock = p.getStockQuantity() == null ? 0 : p.getStockQuantity();

        List<Integer> presets = Optional.ofNullable(p.getPresetsCsv())
                .filter(s -> !s.isBlank())
                .map(s -> Arrays.stream(s.split(","))
                        .map(String::trim)
                        .filter(x -> !x.isEmpty())
                        .map(Integer::valueOf)
                        .collect(Collectors.toList()))
                .orElse(List.of());

        int qMin = Optional.ofNullable(p.getQuantityMin()).orElse(1);
        int qStep = Optional.ofNullable(p.getQuantityStep()).orElse(1);
        int qMax = Optional.ofNullable(p.getQuantityMax()).orElse(stock);

        if (qMin < 1 || qMax < qMin || qStep < 1) {
            throw new InvalidInputException("ÏöîÏ≤≠ ÌïÑÎìúÍ∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.");
        }

        var quantity = new ProductOptionResponse.Quantity(qMin, qMax, qStep);

        return new ProductOptionResponse(
                p.getId(),
                unitLabel,
                p.getPrice(),
                stock,
                presets,
                quantity
        );
    }

    // 6-1) ÏÉÅÌíà Îì±Î°ù(1)-ÏÉÅÌíà Í∏∞Î≥∏Ï†ïÎ≥¥ ÏÉùÏÑ±
    @Transactional
    public Product createBasicProduct(Long requesterUserId, CreateProductRequest req) {
        // 1) Ïù∏Ï¶ù/Í∂åÌïú
        User seller = userRepository.findById(requesterUserId)
                .orElseThrow(() -> new UnauthenticatedException("Ïù∏Ï¶ùÏù¥ ÌïÑÏöîÌï©ÎãàÎã§."));
        if (seller.getRole() == null || !seller.getRole().name().equals("SELLER")) {
            throw new ForbiddenException("ÌåêÎß§Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
        }

        // 2) Ïπ¥ÌÖåÍ≥†Î¶¨
        Category category = null;
        if (req.getCategoryId() != null) {
            Long cid = req.getCategoryId();
            category = categoryRepository.findById(cid).orElseGet(() -> {
                String generatedName = "Ïπ¥ÌÖåÍ≥†Î¶¨ " + cid;
                try {
                    categoryRepository.insertWithId(cid, generatedName);
                } catch (DataIntegrityViolationException e) {
                    // ÎèôÏãúÏÑ± Îì±ÏúºÎ°ú Ïù¥ÎØ∏ ÏÉùÏÑ±Îêú Í≤ΩÏö∞ Î¨¥Ïãú
                }
                return categoryRepository.findById(cid)
                        .orElseThrow(() -> new ResourceNotFoundException("Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÉùÏÑ±/Ï°∞Ìöå Ïã§Ìå®: " + cid));
            });
        }

        // 3) ÏÉÅÌíà Ï†ÄÏû•
        Product p = Product.builder()
                .name(req.getName())
                .price(req.getPrice())
                .stockQuantity(req.getStockQuantity())
                .info(req.getInfo())
                .category(category)
                .userId(seller.getId())
                .gradeId(null)
                .createdAt(LocalDateTime.now())
                .build();

        return productRepository.save(p);
    }

    // 6-2) ÏÉÅÌíà Îì±Î°ù(2)-ÏÉÅÌíà Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú
    @Transactional
    public UploadProductImageResponse uploadProductImage(Long sellerId,
                                                         Long productId,
                                                         MultipartFile file,
                                                         boolean isMain,
                                                         boolean runAi) {
        if (file == null || file.isEmpty()) {
            throw new InvalidInputException("ÌååÏùºÏù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.");
        }

        // ÌååÏùº ÌôïÏû•Ïûê Í≤ÄÏ¶ù
        String original = file.getOriginalFilename();
        String ext = (original != null && original.contains(".")) ?
                original.substring(original.lastIndexOf('.') + 1).toLowerCase() : "";
        if (!ALLOWED_EXT.contains(ext)) {
            throw new InvalidInputException("ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌååÏùº ÌòïÏãùÏûÖÎãàÎã§.(jpg/png/webp)");
        }

        // ÏÉÅÌíà Ï°∞Ìöå + ÏÜåÏú†Ïûê Í≤ÄÏ¶ù
        Product product = productRepository.findById(productId)
                .orElseThrow(() -> new ResourceNotFoundException("ÏÉÅÌíàÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."));
        if (product.getUserId() == null || !product.getUserId().equals(sellerId)) {
            throw new ForbiddenException("Ìï¥Îãπ ÏÉÅÌíàÏùò ÏÜåÏú†ÏûêÍ∞Ä ÏïÑÎãôÎãàÎã§.");
        }

        try {
            // Ï†ÄÏû• Í≤ΩÎ°ú Ï§ÄÎπÑ
            Path dir = Paths.get(uploadRootDir, "products", String.valueOf(productId)).toAbsolutePath();
            Files.createDirectories(dir);

            String newName = UUID.randomUUID().toString().replace("-", "") + "." + ext;
            Path dest = dir.resolve(newName);

            // Ï†ÄÏû•
            file.transferTo(dest.toFile());

            // Ï†ïÏ†Å Ï†ëÍ∑º URL Íµ¨ÏÑ± (/uploads/** Îß§Ìïë)
            String url = "/uploads/products/" + productId + "/" + newName;

            // ÎåÄÌëú Ïù¥ÎØ∏ÏßÄ ÌîåÎûòÍ∑∏ Ï≤òÎ¶¨
            if (isMain) {
                productImageRepository.clearMainByProductId(productId);
                product.setImageMainUrl(url);
                productRepository.save(product);
            }

            // ÏóîÌã∞Ìã∞ Ï†ÄÏû•
            ProductImage saved = productImageRepository.save(
                    ProductImage.builder()
                            .product(product)
                            .imageUrl(url)
                            .isMain(isMain)
                            .createdAt(LocalDateTime.now())
                            .build()
            );

            // Í∏∞Î≥∏ ÏùëÎãµ DTO
            UploadProductImageResponse.Image imageDto = UploadProductImageResponse.Image.builder()
                    .image_id(saved.getId())
                    .image_url(saved.getImageUrl())
                    .is_main(saved.isMain())
                    .ai_processed(false)
                    .build();

            UploadProductImageResponse.ProductInfo productDto = UploadProductImageResponse.ProductInfo.builder()
                    .product_id(product.getId())
                    .grade_id(product.getGradeId())
                    .freshness(null)
                    .build();

            // üî• AI Ìò∏Ï∂ú (ÏÑ†ÌÉùÏ†Å)
            if (runAi) {
                var aiResult = fastApiClient.sendToFastApi(file);
                if (aiResult != null && aiResult.getFreshness() != null) {
                    var f = aiResult.getFreshness();

                    Long grade = f.getGrade(); // ‚Üê ÏúÑ ‚ë†ÏùÑ Ï†ÅÏö©ÌñàÏúºÎ©¥ Í∑∏ÎåÄÎ°ú Long

                    product.setGradeId(grade);
                    productRepository.save(product);

                    productDto.setGrade_id(grade);

                    // FastAPI FreshnessDto -> UploadProductImageResponse.Freshness Î°ú Î≥ÄÌôò
                    UploadProductImageResponse.Freshness freshness =
                            UploadProductImageResponse.Freshness.builder()
                                    .grade(grade)
                                    .label(f.getLabel())
                                    .build();
                    productDto.setFreshness(freshness);

                    imageDto.setAi_processed(true);
                }
            }

            return UploadProductImageResponse.builder()
                    .image(imageDto)
                    .product(productDto)
                    .build();

        } catch (IOException e) {
            throw new RuntimeException("ÌååÏùº Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù", e);
        }
    }

    // 6-3) ÌåêÎß§Ïûê ÏÉÅÌíà Î™©Î°ù Ï°∞Ìöå
    @Transactional(readOnly = true)
    public SellerProductListResponse getSellerProducts(Long sellerId,
                                                       String q,
                                                       Long categoryId,
                                                       String status,
                                                       String sort,
                                                       Integer page,
                                                       Integer size) {

        int p = (page == null || page < 1) ? 1 : page; // 1-based ÏûÖÎ†•
        int s = (size == null) ? 20 : size;
        if (s < 1 || s > 100) {
            throw new InvalidInputException("sizeÎäî 1~100 ÏÇ¨Ïù¥Ïó¨Ïïº Ìï©ÎãàÎã§.");
        }

        String normalizedStatus = null;
        if (status != null && !status.isBlank()) {
            switch (status) {
                case "active", "out_of_stock" -> normalizedStatus = status;
                case "deleted" -> throw new InvalidInputException("deleted ÏÉÅÌÉú ÌïÑÌÑ∞Îäî ÏïÑÏßÅ ÏßÄÏõêÎêòÏßÄ ÏïäÏäµÎãàÎã§.");
                default -> throw new InvalidInputException("ÌóàÏö©ÎêòÏßÄ ÏïäÏùÄ ÏÉÅÌÉú Í∞íÏûÖÎãàÎã§.");
            }
        }

        Sort sortObj = switch (sort == null ? "latest" : sort) {
            case "latest" -> Sort.by(Sort.Direction.DESC, "createdAt");
            case "price_asc" -> Sort.by(Sort.Direction.ASC, "price");
            case "price_desc" -> Sort.by(Sort.Direction.DESC, "price");
            case "stock_asc" -> Sort.by(Sort.Direction.ASC, "stockQuantity");
            case "stock_desc" -> Sort.by(Sort.Direction.DESC, "stockQuantity");
            default -> throw new InvalidInputException("ÌóàÏö©ÎêòÏßÄ ÏïäÏùÄ Ï†ïÎ†¨ Í∞íÏûÖÎãàÎã§.");
        };

        PageRequest pageable = PageRequest.of(p - 1, s, sortObj);

        Page<Product> pageResult = productRepository.findSellerProducts(
                sellerId,
                (q == null || q.isBlank()) ? null : q,
                categoryId,
                normalizedStatus,
                pageable
        );

        // Î™ÖÏãúÏ†Å ÌÉÄÏûÖ + Collectors.toList() ÏÇ¨Ïö©
        List<SellerProductListResponse.Item> items = pageResult.getContent().stream()
                .map(pv -> {
                    SellerProductListResponse.Freshness freshness = (pv.getGradeId() == null) ? null
                            : SellerProductListResponse.Freshness.builder()
                            .grade_id(pv.getGradeId())
                            .grade(pv.getGradeId().intValue())
                            .label(toFreshnessLabel(pv.getGradeId()))
                            .build();

                    String computedStatus = (pv.getStockQuantity() == null || pv.getStockQuantity() == 0)
                            ? "out_of_stock" : "active";

                    return SellerProductListResponse.Item.builder()
                            .product_id(pv.getId())
                            .name(pv.getName())
                            .price(pv.getPrice())
                            .stock_quantity(pv.getStockQuantity())
                            .status(computedStatus)
                            .category_id(pv.getCategory() != null ? pv.getCategory().getId() : null)
                            .main_image_url(pv.getImageMainUrl())
                            .freshness(freshness)
                            .created_at(pv.getCreatedAt())
                            // .updated_at(pv.getUpdatedAt()) // ÌòÑÏû¨ ÏóîÌã∞Ìã∞Ïóê Í≤åÌÑ∞Í∞Ä ÏóÜÏñ¥ÏÑú Ï†úÏô∏
                            .build();
                })
                .collect(Collectors.toList());

        SellerProductListResponse.Pagination pagination = SellerProductListResponse.Pagination.builder()
                .page(p)
                .size(s)
                .total(pageResult.getTotalElements())
                .build();

        return SellerProductListResponse.builder()
                .items(items)
                .pagination(pagination)
                .build();
    }

    // === Ïã†ÏÑ†ÎèÑ ÎùºÎ≤®: 3Îã®Í≥Ñ(3=Îß§Ïö∞ Ïã†ÏÑ†, 2=ÏñëÌò∏, 1=ÌåêÎß§ÏûÑÎ∞ï) ===
    private String toFreshnessLabel(Long gradeId) {
        if (gradeId == null) return null;
        return switch (gradeId.intValue()) {
            case 3 -> "Îß§Ïö∞ Ïã†ÏÑ†";
            case 2 -> "ÏñëÌò∏";
            case 1 -> "ÌåêÎß§ÏûÑÎ∞ï";
            default -> null;
        };
    }
}
